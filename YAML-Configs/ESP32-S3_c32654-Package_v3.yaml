# ESPHome MacroPad S3
# esphome-web-c32654 Version 3
# File Description: External Package

# [ ==== Time Info ==== ] #
time:
  - platform: homeassistant
    id: ha_time
    timezone: "America/Chicago"

# [ ==== Matrix Keypad Configuration ==== ]
matrix_keypad:
  id: macropad_s3_keypad
  rows:
    - pin:
        number: GPIO8
        mode: { output: true }
    - pin:
        number: GPIO9
        mode: { output: true }
    - pin:
        number: GPIO10
        mode: { output: true }
  columns:
    - pin:
        number: GPIO11
        mode: { input: true, pullup: true }
    - pin:
        number: GPIO12
        mode: { input: true, pullup: true }
    - pin:
        number: GPIO13
        mode: { input: true, pullup: true }
  keys: "123456789"
  has_diodes: false

# [ ==== Globals Info ==== ] #
# globals: [PLACEHOLDER]

# [ ==== Sensor Info ==== ] #
# sensor: [PLACEHOLDER]

# [ ==== Binary Sensors ==== ]
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      ignore_strapping_warning: true
      inverted: true
      mode: { input: true, pullup: true }
    name: "Boot Button - MacroPad S3"
    icon: mdi:gesture-tap-button

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_1_macropad_s3
    key: "1"
    name: "Key 1 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 1
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 1

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_2_macropad_s3
    key: "2"
    name: "Key 2 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 2
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 2

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_3_macropad_s3
    key: "3"
    name: "Key 3 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 3
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 3

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_4_macropad_s3
    key: "4"
    name: "Key 4 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 4
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 4

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_5_macropad_s3
    key: "5"
    name: "Key 5 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 5
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 5

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_6_macropad_s3
    key: "6"
    name: "Key 6 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 6
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 6

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_7_macropad_s3
    key: "7"
    name: "Key 7 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 7
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 7

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_8_macropad_s3
    key: "8"
    name: "Key 8 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 8
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 8

  - platform: matrix_keypad
    keypad_id: macropad_s3_keypad
    id: key_9_macropad_s3
    key: "9"
    name: "Key 9 - MacroPad S3"
    on_press:
      - script.execute:
          id: handle_key_action
          key_num: 9
    on_release:
      - script.execute: reset_led_to_rainbow
    on_click:
      - min_length: 2s
        max_length: 5s
        then:
          - script.execute:
              id: handle_key_hold_action
              key_num: 9

# [ ==== Text Sensor Info ==== ] #
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address - MacroPad S3"
      icon: mdi:ip-network
  - platform: version
    name: "ESPHome Version - MacroPad S3"
    icon: mdi:car-esp

# [ ==== Script Info ==== ] #
script:
  - id: handle_key_action
    parameters:
      key_num: int
    then:
      # Set LED to white on press
      - light.turn_on:
          id: rgb_led
          red: 100%
          green: 100%
          blue: 100%
          brightness: 100%
          effect: none
      # Execute Home Assistant action
      - lambda: |-
          std::string entity;
          std::string action;
          switch(key_num) {
            case 1: entity = "${key_1_entity}"; action = "${key_1_action}"; break;
            case 2: entity = "${key_2_entity}"; action = "${key_2_action}"; break;
            case 3: entity = "${key_3_entity}"; action = "${key_3_action}"; break;
            case 4: entity = "${key_4_entity}"; action = "${key_4_action}"; break;
            case 5: entity = "${key_5_entity}"; action = "${key_5_action}"; break;
            case 6: entity = "${key_6_entity}"; action = "${key_6_action}"; break;
            case 7: entity = "${key_7_entity}"; action = "${key_7_action}"; break;
            case 8: entity = "${key_8_entity}"; action = "${key_8_action}"; break;
            case 9: entity = "${key_9_entity}"; action = "${key_9_action}"; break;
          }
          auto call = id(homeassistant).call_service(action.c_str());
          call.add_data("entity_id", entity.c_str());
          call.perform();

  - id: handle_key_hold_action
    parameters:
      key_num: int
    then:
      # Set LED to white on press
      - light.turn_on:
          id: rgb_led
          red: 0%
          green: 20%
          blue: 100%
          brightness: 100%
          effect: none
      # Execute Home Assistant action
      - lambda: |-
          std::string entity;
          std::string action;
          switch(key_num) {
            case 1: entity = "${key_1_entity_hold}"; action = "${key_1_action_hold}"; break;
            case 2: entity = "${key_2_entity_hold}"; action = "${key_2_action_hold}"; break;
            case 3: entity = "${key_3_entity_hold}"; action = "${key_3_action_hold}"; break;
            case 4: entity = "${key_4_entity_hold}"; action = "${key_4_action_hold}"; break;
            case 5: entity = "${key_5_entity_hold}"; action = "${key_5_action_hold}"; break;
            case 6: entity = "${key_6_entity_hold}"; action = "${key_6_action_hold}"; break;
            case 7: entity = "${key_7_entity_hold}"; action = "${key_7_action_hold}"; break;
            case 8: entity = "${key_8_entity_hold}"; action = "${key_8_action_hold}"; break;
            case 9: entity = "${key_9_entity_hold}"; action = "${key_9_action_hold}"; break;
          }
          auto call = id(homeassistant).call_service(action.c_str());
          call.add_data("entity_id", entity.c_str());
          call.perform();

  - id: reset_led_to_rainbow
    mode: restart
    then:
      - light.turn_on:
          id: rgb_led
          effect: rainbow
          brightness: 100%
